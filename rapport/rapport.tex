\documentclass[a4paper,11pt]{scrartcl}

\usepackage{graphicx}
\usepackage[utf8]{inputenc} %-- pour utiliser des accents en français
\usepackage{url}
\usepackage[left=20mm,top=20mm]{geometry}
\usepackage[french]{babel}
\usepackage{hyperref}
\usepackage{minted} %-- code style
\title{Sécurité - CVE 2018--10933}
\author{Cyril Dussert - Emilien Mottet\\ \url{https://www.cvedetails.com/cve/CVE-2018-10933/}}
\date{\today}

\begin{document}

\maketitle

\section{Service compromis}\label{sec:serviceCompromis}

La faille de sécurité etudiée (CVE 2018--10933) concerne la librairie \verb|libssh| côté serveur dans les versions inférieures à 0.7.6 et 0.8.4. Néanmoins, des systèmes Linux embarquent la librairie dans leurs dépôts. Ces systèmes deviennent ainsi aussi vulnérables.
Il s'agit d'Ubuntu pour ses versions LTS (14.04, 16.04 et 18.04), ainsi que Debian Stretch (9.0).
Le risque est un contournement de la politique de sécurité.

Le type de cette faille est principalement \verb|Authentication Issues|.

Cette faille de sécurité affecte les applications qui utilisent \verb|libssh| pour implémenter un serveur SSH. Le client SSH n'est pas concerné.
Cette faille ne concerne pas \verb|libssh2| ni \verb|openssh|.

\section{Description de la vulnérabilité}\label{sec:descriptionDeLaVulnerabilite}
Cette faille permet une authentification non autorisée sur un serveur.
Au cours de l'échange lors de l'authentification d'un client aurpès d'un serveur, la simple présentation d'un message \verb|SSH2_MSG_USERAUTH_SUCCESS| de la part du client, à la place d'un \verb|SSH2_MSG_USERAUTH_REQUEST| (normalement attendu).
permet à l'attaquant de s'authentifier correctement sans aucun besoin d'identifiants.

\begin{figure}
\begin{center}
    \includegraphics[scale=0.7]{./images/draw-cve-2018-10933.jpg}
    \caption{CVE-2018-10933 in real world}
    \label{CVE-2018-10933 in real world}
  \end{center}
\end{figure}


\section{Cibles de la faille}\label{sec:ciblesDeLaFaille}
Comme décrit ci-dessus, les cibles concernées par cette faille sont les serveurs utilisant la librairie \verb|libssh| comme serveur SSH.
\subsection{Versions concernées}\label{subsec:versionsConcernees}
\begin{itemize}
    \item Versions supérieures à 0.6
    \item Version inférieures à 0.7.6
    \item Version inférieures à 0.8.4
\end{itemize}

\subsection{Trouver des victimes}\label{subsec:trouvervictimes}
Grâce à shodan (google du hacker) nous pouvons trouver une liste de serveur
utilisant une librairie potentiellement. Screenshot disponible dans le README.md

\url{https://www.shodan.io/search?query=product%3A%22libssh%22+version%3A%220.6.3%22}

\section{Exemple d'architecture}\label{sec:exempleD'architecture}

La dangerosité de cette faille est qu'il n'y a pas besoin d'une architecture
spécifique pour l'exploiter. Il suffit de voir les distributions vulnérables
debian et ubuntu surtout qu'il existe un grand nombre de distributions basées
sur ces distributions.
Il suffit d'un serveur, accessible sur un réseau (par exemple, internet), utilisant \verb|libssh| pour son serveur SSH et d'un client malicieux.

Une architecture faillible peut être un serveur avec un service sshd sur un port
exposé. Et que son serveur ssh utilise une librairie libssh vulnérable. 


\section{Préconisations de sécurité}\label{sec:preconisationsDeSecurite}
Etant donné qu'il n'y à pas de workaround directement accessible pour palier cette faille, la meilleure solution pour s'en protéger est de mettre à jour \textbf{régulièrement} les librairies présentes sur le serveur.
Peu de temps après la découverte de la faille, un patch correctif (versions 0.7.6 et 0.8.4) était disponible.

Un bon moyen de suivre les différents problèmes de sécurité importants est de regarder régulièrement les bugs les plus critiques déclarés par les différents systèmes d'exploitation (par exemple, Ubuntu security notices : \url{https://usn.ubuntu.com/}).
Pour le cas de debian (\url{https://www.debian.org/security/}), il  est une très bonne pratique d'ajouter le dépot
debian-security. Avec cette ligne à ajouter dans votre \mintinline{bash}{/etc/apt/sources.list} 
\begin{minted}{debsources}
  deb http://security.debian.org/debian-security stretch/updates main contrib non-free
\end{minted}


Il va de soi que le mieux est d'avoir une infrastructure homogène (mêmes bases logicielles sur différents serveurs), afin de pouvoir réagir efficacement (un seul patch à appliquer).

Dans le cas des systèmes RedHat Enterprise Linux, les notifications par mail des nouvelles failles sont très efficaces.
De plus, il ne faut pas hésiter à faire appel au support en cas de doute sur n'importe quel point en rapport avec le système d'exploitation.

\subsection{Bonnes pratiques à mettre en oeuvre}\label{sec:bonnesPratiquesAMettreEnOeuvre}
Voici une liste de bonnes pratiques qui pourraient vous sauver la vie dans le cadre de cette faille :
\begin{itemize}
    \item Mettre à jour le système régulièrement
    \item Ne pas exposer son serveur SSH directement sur internet (bien configurer son iptables)
    \item Changer le port d'écoute par défaut de SSH et éviter les ports communs (6291 par exemple)
    \item Interdire à root de se connecter au serveur via SSH
      (\mintinline{bash}{PermitRootLogin no} dans
      \mintinline{bash}{/etc/ssh/sshd_config}) et avoir une bonne gestion des
      sudoers 
    \item Utiliser un framework de prévention d'intrusions (ex : Fail2ban)
    \item Avoir un système de log. Sur ubuntu /var/log/auth.log. Nous n'avons
      pas réussi à vérifier ceci, car nous avons testé avec l'exemple fourni par
      libssh et qui est limité pas de variable d'environnement initialisé à la
      connection et pas de log. 
\end{itemize}
\section{Améliorer le développement}\label{sec:nePasReproduire}
Nous n'avons pas trouvé le commit créant la faille de sécurité. Mais une telle
faille est surprenante. Les tests ne doivent pas être négligé dans le génie
logiciel. Des tests en boites noires, comme par exemple des tests fonctionnels
essayant de reproduire des comportements malicieux aurait pu éviter peut-être
une telle faille. 
\section{PSSI}\label{sec:pssi}
Nous imaginons que nous sommes dans une grosse industrie (type Orange/Michelin,
au hasard).
\subsection{Criticité de la faille et potentiel impact}
La facilité d'exploitation de la faille est effrayante et peut permettre à un
attaquant de nuire à un SI assez facilement. Mais pour un groupe, plusieurs
garde-fous sont déjà présent et efficaces. À notre connaissance notre industrie
n'a pas d'accès ssh ouvert directement sur internet. Aucun port ssh trouvé sur shodan pour un
nom de domaine Michelin.

Par contre, une personne avec de mauvaises intentions, ayant un accès sur
l'intranet pourrait nous faire très mal. Il est tellement fréquent d'avoir les
ports ssh ouverts sur les serveurs que je pense même que c'est peut-être par
défaut. Donc tous les serveurs sont potentiellement faillibles. Évidemment
l'utilisateur root ne peut se connecter directement aux machines. Mais les
comptes pouvant se connecter sont présents dans les sudoers. Ils détiennent en général de
nombreux privilèges, comme se connecter en root. Donc cette faille, combinée avec
une élévation de privilèges est rendue facilement exécutable par des sudoers laxistes. Par
expérience le logging des connexions n'est pas très bien réalisé.

En résumé, depuis internet presque aucun danger, mais depuis l'intranet, il exsite beaucoup de dangers.

\subsection{Action préventive et curative}
Ne pas donner d'accès à l'intranet depuis internet. Comme le SI de
l'Ensimag, nous ne pouvons pas nous connecter directement, nous devons faire un
rebond par depots.ensimag.fr. Ceci ne laisse pas entrer l'attaquant directement
sur l'intranet.

Revoir la gestions des sudoers.

Ne pas avoir de serveur ssh démarré par défaut sur les machines.
Avoir un système de logs performant, quitte à forcer les utilisateurs à utiliser des logiciels côté client pour se connecter (exemple : enregistrement des sessions vidéos de tout ce qui est fait sur la machine).

Automatiser les déploiements logiciels en n'utilisant pas SSH. Il est possible
de n'utiliser que https.
Destruction des machines virtuelles après une connection ssh sur la machine
(exemple de la présentation Uber).

\subsection{Formation des utilisateurs à envisager}
Avoir des sysadmins à la pointe, lecteurs des maillings lists des distributions
installés sur les serveurs.
Automatiser au maximum les opérations de déploiement et gestion de la vie du
logiciel. Les actions manuelles en SSH sur une machine doivent être limitées, voire prohibées.
Utiliser des distributions respectables (debian,ubuntu,redhat,gentoo), avec des sources logicielles fiables.
Faire la guerre au shadow IT, c'est le mal des SI et aussi un danger pour la
sécurité de l'entreprise. Si la DSI ne maitrise pas son SI, il est très délicat d'avoir une bonne sécurité.

La gestion des serveurs doit ainsi suivre une politique d'entreprise stricte (datacenters propres, ou IaaS de prédilection...), pour n'importe quel projet.

\section{Expérimentation}\label{sec:experimentation}
\subsection{Le serveur}
Afin de rendre facile cette expérimentation, nous vous avons préparé une image Docker contenant un seveur SSH utilisant \verb|libssh 0.7.4|
Tout cela se trouve dans le dossier \verb|libssh-7.4-ssh_server_fork| et un simple \verb|docker build -t unsecure-libssh .| au sein du dossier permettra de construire l'image.

Ensuite, il vous suffit de démarrer le serveur sur le port de votre choix (ici 2222) en utilisant \verb|docker run -it -p 2222:22 unsecure-libssh|.
\subsection{Le client malicieux}
Côté client, un script pour l'exploitation de cette faille est disponible dans le dossier \verb|script|. Vous avez juste besoin d'une version récente de Python (par exemple 3.6) pour l'exécuter.
N'oubliez pas d'installer les librairies tierces requises en exécutant \verb|pip install -r requirements.txt| au sein du dossier.

Ensuite, le script fonctionne comme suit : \verb|python exploit.py <host> <port> <command>|. Exécutez-le de manière à contacter le conteneur Docker préalablement lancé, par exemple :
\verb|python exploit.py localhost 2222 id| exécutera la commande \verb|id| au sein de l'image Docker et affichera la sortie sur le terminal.
Vous devriez normalement voir une sortie du genre :

\begin{verbatim}
(venv) $ python script/exploit.py localhost 2222 id
INFO:paramiko.transport:Connected (version 2.0, client libssh_0.7.4)
uid=0(root) gid=0(root) groups=0(root)
\end{verbatim}

On remarque que le client n'a eu besoin d'aucune authentification et a pu exécuter une commande en tant que root...
\end{document}